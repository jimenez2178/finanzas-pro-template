<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Pro - Plantilla</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0a0b10;
            --card-bg: #1e212b;
            --neon-yellow: #f8d800;
            --neon-blue: #00e5ff;
            --danger-red: #ff4d4d;
            --text-white: #ffffff;
            --gray-sub: #8a8a8e;
            --neon-purple: #bc13fe;
        }
        body { background-color: var(--bg-dark); color: var(--text-white); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; padding-bottom: 120px; }
        #lock-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-dark); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--neon-yellow); margin: 0 10px; transition: 0.2s; }
        .pin-dot.filled { background: var(--neon-yellow); box-shadow: 0 0 15px var(--neon-yellow); }
        .pin-keypad { display: grid; grid-template-columns: repeat(3, 75px); gap: 15px; margin-top: 30px; }
        .key { width: 75px; height: 75px; border-radius: 50%; background: #1a1c23; border: 1px solid #333; color: white; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .expense-card { background: var(--card-bg); border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        .priority-high-active { animation: neon-throb 1.5s infinite alternate; border: 1px solid var(--neon-purple) !important; }
        @keyframes neon-throb { from { box-shadow: 0 0 5px var(--neon-purple); } to { box-shadow: 0 0 20px var(--neon-purple); } }
        .card-paid { border-left: 8px solid var(--neon-blue) !important; opacity: 0.8; }
        .alert-tag { background: rgba(255, 77, 77, 0.2); color: var(--danger-red); padding: 4px 8px; border-radius: 8px; font-size: 0.65rem; font-weight: bold; margin-bottom: 8px; display: inline-block; border: 1px solid var(--danger-red); }
        .dashboard-main { background: var(--card-bg); border-radius: 25px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; position: relative; }
        .budget-container { width: 100%; background: #2c2f3a; height: 12px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .budget-bar { height: 100%; transition: 0.8s; background: var(--neon-blue); }
        .btn-nav { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; background: #2c2f3a; color: white; cursor: pointer; font-size: 0.75rem; }
        .btn-nav.active { background: var(--neon-yellow) !important; color: black !important; }
        .btn-float { position: fixed; bottom: 25px; right: 25px; width: 70px; height: 70px; border-radius: 50%; background: var(--neon-yellow); color: black; border: none; font-size: 2.5rem; box-shadow: 0 0 20px var(--neon-yellow); z-index: 1000; }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 100%; max-width: 400px; border: 1px solid var(--neon-yellow); margin-top: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #2c2f3a; border: 1px solid #444; border-radius: 10px; color: white; box-sizing: border-box; font-size: 1rem; }
        label { font-size: 0.75rem; color: var(--neon-yellow); font-weight: bold; display: block; margin-top: 10px; }
        .ia-card-tip { background: rgba(0, 229, 255, 0.1); padding: 10px; border-radius: 12px; border: 1px solid var(--neon-blue); margin-bottom: 15px; font-size: 0.85rem; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
    <div id="lock-screen">
        <h3 id="lock-title" style="color: var(--neon-yellow);">SISTEMA DE SEGURIDAD</h3>
        <div style="display: flex; margin: 20px 0;">
            <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
            <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
        </div>
        <div class="pin-keypad">
            <div class="key" onclick="pressPin(1)">1</div><div class="key" onclick="pressPin(2)">2</div><div class="key" onclick="pressPin(3)">3</div>
            <div class="key" onclick="pressPin(4)">4</div><div class="key" onclick="pressPin(5)">5</div><div class="key" onclick="pressPin(6)">6</div>
            <div class="key" onclick="pressPin(7)">7</div><div class="key" onclick="pressPin(8)">8</div><div class="key" onclick="pressPin(9)">9</div>
            <div class="key" style="opacity:0"></div><div class="key" onclick="pressPin(0)">0</div><div class="key" onclick="pressPin('C')">C</div>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="app-title-display" onclick="renameApp()" style="color:var(--neon-yellow); cursor:pointer;">Finanzas Pro üìù</h2>
            <button class="btn-nav" style="flex:none; padding:10px 15px;" onclick="openAccModal()">+ BANCO</button>
        </div>

        <div id="ia-tip-area"></div>

        <div class="dashboard-main">
            <button onclick="toggleTools()" style="position:absolute; top:15px; right:15px; background:none; border:none; color:var(--gray-sub); font-size:1.5rem; cursor:pointer;">‚öôÔ∏è</button>
            <div style="display:flex; align-items:center; gap:20px;">
                <div style="width:80px; height:80px; position:relative; display:flex; align-items:center; justify-content:center;">
                    <canvas id="mainChart"></canvas>
                    <b id="perc-val" style="position:absolute; color:var(--neon-yellow); font-size:0.8rem;">0%</b>
                </div>
                <div style="flex:1">
                    <b id="budget-text" style="font-size:0.9rem">RD$ 0 / 0</b>
                    <div class="budget-container"><div id="budget-bar" class="budget-bar"></div></div>
                </div>
            </div>
            <div id="balances-area" style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            
            <div id="tools-section" style="display:none; border-top:1px solid #444; margin-top:15px; padding-top:15px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-nav" onclick="changePin()">üîê PIN</button>
                    <button class="btn-nav" onclick="renameApp()">‚úèÔ∏è Nombre</button>
                    <button class="btn-nav" onclick="makeBackup()">üíæ Backup</button>
                    <button class="btn-nav" onclick="importBackup()">üìÇ Cargar</button>
                    <button class="btn-nav" style="color:red; grid-column: span 2;" onclick="resetApp()">üîÑ Reset App</button>
                </div>
            </div>
        </div>

        <div class="nav-bar" style="display:flex; gap:5px; margin-bottom: 20px;">
            <button id="btn-q1" class="btn-nav active" onclick="setView('q1')">1ra Quincena</button>
            <button id="btn-q2" class="btn-nav" onclick="setView('q2')">2da Quincena</button>
            <button id="btn-history" class="btn-nav" onclick="setView('history')">Historial</button>
        </div>

        <div id="list-container"></div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--neon-yellow);">Nuevo Registro</h3>
            <input type="hidden" id="edit-id">
            <label>Nombre del Pago</label>
            <input type="text" id="in-name" placeholder="Ej: Pago de Luz">
            <label>Monto RD$</label>
            <input type="number" id="in-amt" placeholder="0.00">
            <label>Fecha de Vencimiento</label>
            <input type="date" id="in-due-date">
            <label>Banco/Cuenta</label>
            <select id="in-account"></select>
            <label>Categor√≠a</label>
            <select id="in-cat" onchange="updateSubs()">
                <option value="Casa">üè† Casa</option>
                <option value="Servicios">‚ö° Servicios</option>
                <option value="Veh√≠culo">üöó Veh√≠culo</option>
                <option value="Personal">üë§ Personal</option>
                <option value="Finanzas">üí≥ Pr√©stamos/Tarjetas</option>
                <option value="Familia">üë®‚Äçüë©‚Äçüëß Familia/Mascotas</option>
                <option value="Otros">üì¶ Otros</option>
            </select>
            <label>Sub-Categor√≠a</label>
            <select id="in-sub"></select>
            <label>Prioridad</label>
            <select id="in-priority"><option value="low">Normal</option><option value="high">ALTA üî•</option></select>
            <label>Notas</label>
            <textarea id="in-note" rows="2" placeholder="Notas..."></textarea>
            <label>Foto/Factura</label>
            <input type="file" id="in-photo" accept="image/*" capture="environment">
            <button class="btn-nav" style="background:var(--neon-yellow); color:black; width:100%; margin-top:20px; padding:15px;" onclick="saveEntry()">GUARDAR</button>
            <button class="btn-nav" style="width:100%; margin-top:10px" onclick="closeModal()">CANCELAR</button>
        </div>
    </div>

    <div id="accModal" class="modal">
        <div class="modal-content">
            <h3>Nuevo Banco / Tarjeta</h3>
            <input type="text" id="acc-name" placeholder="Nombre (Ej: Popular, BHD)">
            <input type="number" id="acc-bal" placeholder="Saldo Actual">
            <button class="btn-nav" onclick="saveAccount()" style="background:var(--neon-blue); color:black; width:100%;">REGISTRAR</button>
        </div>
    </div>

    <button class="btn-float" onclick="openModal()">+</button>

    <script>
        const subCats = {
            "Casa": ["Alquiler", "Hipoteca", "Mantenimiento", "Supermercado", "Limpieza", "Reparaci√≥n", "Decoraci√≥n"],
            "Servicios": ["Luz", "Agua", "Internet", "Gas", "Basura", "Celular"],
            "Veh√≠culo": ["Combustible", "Seguro", "Mantenimiento", "Gomas", "Lavado", "Marbete"],
            "Personal": ["Salud", "Farmacia", "Barber√≠a", "Gimnasio", "Ropa", "Diversi√≥n", "Suscripciones"],
            "Finanzas": ["Tarjeta de Cr√©dito", "Pr√©stamo", "Inversi√≥n", "Ahorro"],
            "Familia": ["Colegio", "√ötiles", "Mascotas", "Ayuda Familiar"],
            "Otros": ["Imprevistos", "Efectivo", "Transferencia", "Peaje"]
        };

        // LLAVE DE ALMACENAMIENTO √öNICA PARA CLIENTES
        const STORAGE_KEY = 'finanzas_pro_user_data';

        let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { 
            appName: "Finanzas Pro", 
            pin: "1234", 
            accounts: [], 
            items: [] 
        };

        let currentView = 'q1', myChart, pinBuffer = "", tempImg = "";

        // Al iniciar, actualizar t√≠tulo de bloqueo
        document.getElementById('lock-title').innerText = "SEGURIDAD - " + data.appName.toUpperCase();

        function pressPin(v) {
            if(v==='C') pinBuffer = ""; else if(pinBuffer.length < 4) pinBuffer += v;
            for(let i=0; i<4; i++) document.getElementById(`dot-${i}`).className = i < pinBuffer.length ? 'pin-dot filled' : 'pin-dot';
            if(pinBuffer.length === 4) { 
                if(pinBuffer === data.pin) { 
                    document.getElementById('lock-screen').style.display='none'; 
                    document.getElementById('app-content').style.display='block'; 
                    render(); 
                } else { 
                    pinBuffer = ""; 
                    alert("PIN Incorrecto");
                    for(let i=0; i<4; i++) document.getElementById(`dot-${i}`).className = 'pin-dot';
                } 
            }
        }

        function render() {
            document.getElementById('app-title-display').innerText = data.appName + " üìù";
            let qNum = currentView === 'q2' ? 2 : 1;
            let filtered = (currentView === 'history') ? data.items.filter(i => i.done) : data.items.filter(i => i.q === qNum);
            const itemsInQ = data.items.filter(i => i.q === qNum);
            const saldado = itemsInQ.filter(i => i.done).reduce((s,i) => s + (i.amt || 0), 0);
            const total = itemsInQ.reduce((s,i) => s + (i.amt || 0), 0);
            
            document.getElementById('budget-text').innerText = `RD$ ${saldado.toLocaleString()} / ${total.toLocaleString()}`;
            document.getElementById('budget-bar').style.width = ((saldado / (total || 1)) * 100) + "%";
            document.getElementById('perc-val').innerText = Math.round((saldado / (total || 1)) * 100) + "%";

            const balArea = document.getElementById('balances-area'); 
            balArea.innerHTML = "";
            let saldosReal = [];
            data.accounts.forEach(acc => {
                const gastado = data.items.filter(i => i.accId === acc.id && i.done).reduce((s,i)=>s+(i.amt||0), 0);
                let saldoActual = acc.balance - gastado;
                saldosReal.push({ name: acc.name, balance: saldoActual });
                balArea.innerHTML += `<div style="background:#2c2f3a; padding:10px; border-radius:12px; font-size:0.75rem;">
                    ${acc.name}<br><b style="color:var(--neon-blue)">RD$ ${saldoActual.toLocaleString()}</b>
                </div>`;
            });

            // IA Tips
            const iaArea = document.getElementById('ia-tip-area');
            if(data.accounts.length === 0) {
                iaArea.innerHTML = `<div class="ia-card-tip">üëã ¬°Bienvenido! Toca el bot√≥n <b>+ BANCO</b> para configurar tus cuentas.</div>`;
            } else if(saldosReal.length > 0) {
                const mejor = saldosReal.sort((a,b) => b.balance - a.balance)[0];
                iaArea.innerHTML = `<div class="ia-card-tip"><span>üí≥</span><span>IA: Tienes m√°s fondos en <b>${mejor.name}</b>. √ösala para tus pr√≥ximos pagos.</span></div>`;
            }

            const container = document.getElementById('list-container'); container.innerHTML = "";
            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:var(--gray-sub); margin-top:40px;">No hay registros en esta secci√≥n.</p>`;
            }

            const hoy = new Date();
            filtered.forEach(item => {
                let alertHtml = "";
                if(item.dueDate && !item.done) {
                    const vence = new Date(item.dueDate);
                    const diff = (vence - hoy) / (1000 * 60 * 60 * 24);
                    if(diff <= 3 && diff >= 0) alertHtml = `<div class="alert-tag">‚ö†Ô∏è VENCE EN ${Math.ceil(diff)} D√çAS</div>`;
                    else if(diff < 0) alertHtml = `<div class="alert-tag">üö® PAGO ATRASADO</div>`;
                }
                container.innerHTML += `<div class="expense-card ${item.done ? 'card-paid' : ''} ${item.priority === 'high' && !item.done ? 'priority-high-active' : ''}">
                    ${alertHtml}
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem;"><span>${item.cat} > ${item.sub}</span><span>${item.dueDate || ''}</span></div>
                    <h3 style="margin:8px 0;">${item.name}</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--neon-yellow);">RD$ ${(item.amt||0).toLocaleString()}</b>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-nav" style="padding:5px 8px; background:var(--neon-blue); color:black;" onclick="toggleSaldar('${item.id}')">${item.done?'ABRIR':'SALDAR'}</button>
                            <button class="btn-nav" style="padding:5px 8px;" onclick="openEdit('${item.id}')">‚úèÔ∏è</button>
                            <button class="btn-nav" style="padding:5px 8px; color:red;" onclick="removeItem('${item.id}')">X</button>
                        </div>
                    </div>
                </div>`;
            });
            updateChart(saldado, (total - saldado));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function toggleSaldar(id) { 
            const i = data.items.find(x => x.id === id); 
            i.done = !i.done; 
            i.paidAt = i.done ? new Date().toLocaleString() : null; 
            render(); 
        }

        function makeBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `backup_${data.appName.replace(/\s+/g, '_')}.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = event => {
                    data = JSON.parse(event.target.result);
                    render();
                    alert("Backup cargado correctamente.");
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        // Resto de funciones auxiliares necesarias para el funcionamiento (mantener igual que el original)
        function setView(v) { currentView = v; document.querySelectorAll('.nav-bar .btn-nav').forEach(b => b.classList.remove('active')); document.getElementById('btn-'+v).classList.add('active'); render(); }
        function openModal() { document.getElementById('edit-id').value = ""; tempImg = ""; document.getElementById('addModal').style.display='flex'; document.getElementById('in-account').innerHTML = data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join(''); updateSubs(); }
        function closeModal() { document.getElementById('addModal').style.display='none'; }
        function openAccModal() { document.getElementById('accModal').style.display='flex'; }
        function toggleTools() { const ts = document.getElementById('tools-section'); ts.style.display = ts.style.display==='none'?'block':'none'; }
        function renameApp() { let n = prompt("Nombre de la App:", data.appName); if(n) { data.appName = n; render(); } }
        function changePin() { let p = prompt("Nuevo PIN (4 d√≠gitos):"); if(p && p.length===4) { data.pin = p; alert("PIN actualizado"); } }
        function resetApp() { if(confirm("¬øSeguro que quieres borrar todo? Esta acci√≥n no se puede deshacer.")) { localStorage.clear(); location.reload(); } }
        function updateSubs() { const c = document.getElementById('in-cat').value; document.getElementById('in-sub').innerHTML = subCats[c].map(s => `<option value="${s}">${s}</option>`).join(''); }
        function saveAccount() { const n = document.getElementById('acc-name').value; if(n) { data.accounts.push({id: Date.now().toString(), name: n, balance: parseFloat(document.getElementById('acc-bal').value)||0}); document.getElementById('accModal').style.display='none'; render(); } }
        function removeItem(id) { if(confirm("¬øEliminar?")) { data.items = data.items.filter(x => x.id !== id); render(); } }
        
        function saveEntry() {
            const id = document.getElementById('edit-id').value;
            const nuevo = {
                id: id || Date.now().toString(),
                name: document.getElementById('in-name').value || "Gasto",
                amt: parseFloat(document.getElementById('in-amt').value) || 0,
                q: currentView === 'q2' ? 2 : 1,
                accId: document.getElementById('in-account').value,
                cat: document.getElementById('in-cat').value,
                sub: document.getElementById('in-sub').value,
                priority: document.getElementById('in-priority').value,
                dueDate: document.getElementById('in-due-date').value,
                note: document.getElementById('in-note').value,
                photo: tempImg,
                done: id ? data.items.find(x=>x.id===id).done : false
            };
            if(id) { data.items[data.items.findIndex(x=>x.id===id)] = nuevo; } else { data.items.push(nuevo); }
            closeModal(); render();
        }

        function openEdit(id) {
            const i = data.items.find(x => x.id === id);
            document.getElementById('edit-id').value = i.id;
            document.getElementById('in-name').value = i.name;
            document.getElementById('in-amt').value = i.amt;
            document.getElementById('in-due-date').value = i.dueDate;
            document.getElementById('in-cat').value = i.cat;
            updateSubs();
            document.getElementById('in-sub').value = i.sub;
            document.getElementById('in-account').innerHTML = data.accounts.map(a => `<option value="${a.id}" ${a.id===i.accId?'selected':''}>${a.name}</option>`).join('');
            document.getElementById('addModal').style.display='flex';
        }

        function updateChart(p, n) { 
            const ctx = document.getElementById('mainChart').getContext('2d'); 
            if(myChart) myChart.destroy(); 
            myChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { datasets: [{ data: [p, (p+n===0?1:n)], backgroundColor: ['#00e5ff', '#2c2f3a'], borderWidth: 0 }] }, 
                options: { cutout: '75%', plugins: { legend: { display: false } } } 
            }); 
        }

        // Inicializaci√≥n
        if (!data.accounts) data.accounts = [];
    </script>
</body>
</html>
